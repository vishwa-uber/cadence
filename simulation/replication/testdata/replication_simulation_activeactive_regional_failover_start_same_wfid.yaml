# This file is a replication simulation scenario spec.
# It is parsed into ReplicationSimulationConfig struct.
# Replication simulation for this file can be run via ./simulation/replication/run.sh --scenario activeactive_regional_failover_start_same_wfid
# Dynamic config overrides can be set via config/dynamicconfig/replication_simulation_activeactive_regional_failover_start_same_wfid.yml
# When a domain is configured as active-active
# And a workflow is running in one cluster
# And a failover occurs
# It should not be possible to start another workflow with the same workflowID
# And the request should be rejected with error "Workflow execution is already running"
clusters:
  cluster0:
    grpcEndpoint: "cadence-cluster0:7833"
  cluster1:
    grpcEndpoint: "cadence-cluster1:7833"

# primaryCluster is where domain data is written to and replicates to others. e.g. domain registration
primaryCluster: "cluster0"

domains:
  test-domain-aa:
    activeClusterName: cluster0
    clusterAttributes:
      region:
        region0: cluster0
        region1: cluster1

operations:
  # Start wf1 on cluster1 before failover.
  - op: start_workflow
    at: 0s
    workflowID: wf1
    workflowType: timer-activity-loop-workflow
    cluster: cluster1
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 70s
    workflowDuration: 60s
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region1


  # Failover from cluster1 to cluster0
  - op: change_active_clusters
    at: 10s
    domain: test-domain-aa
    newClusterAttributes:
      region:
        region1: cluster0

  # Attempt to start wf1 on cluster1 again. It will be forwarded to cluster0 and cluster0 should reject with error "Workflow execution is already running".
  - op: start_workflow
    at: 30s
    workflowID: wf1
    workflowType: timer-activity-loop-workflow
    cluster: cluster1
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 70s
    workflowDuration: 60s
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region1
    want:
      error: "Workflow execution is already running"

  # Validate that wf1 is completed in cluster0.
  - op: validate
    at: 80s
    workflowID: wf1
    cluster: cluster1
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster0
