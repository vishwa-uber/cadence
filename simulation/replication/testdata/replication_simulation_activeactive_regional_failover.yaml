# This file is a replication simulation scenario spec.
# It is parsed into ReplicationSimulationConfig struct.
# Replication simulation for this file can be run via ./simulation/replication/run.sh --scenario activeactive_regional_failover
# Dynamic config overrides can be set via config/dynamicconfig/replication_simulation_activeactive_regional_failover.yml
# Tests active-active behaviour during a failover

clusters:
  cluster0:
    grpcEndpoint: "cadence-cluster0:7833"
  cluster1:
    grpcEndpoint: "cadence-cluster1:7833"

# primaryCluster is where domain data is written to and replicates to others. e.g. domain registration
primaryCluster: "cluster0"

domains:
  test-domain-aa:
    activeClusterName: cluster0
    clusterAttributes:
      region:
        region0: cluster0
        region1: cluster1

operations:
  # Start wf1 on cluster0 before failover. It should start in cluster0 and complete in cluster1.
  - op: start_workflow
    at: 0s
    workflowID: wf1
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 60s
    workflowID: wf1
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster0
      completedByWorkersInCluster: cluster1

  # Failover from cluster0 to cluster1
  - op: change_active_clusters
    at: 10s
    domain: test-domain-aa
    newClusterAttributes:
      region:
        region0: cluster1 # this is changed from cluster0 to cluster1
        region1: cluster1

  # Start wf2 on cluster0 right before failover. It will be started by cluster0 workers and completed by cluster1 workers.
  - op: start_workflow
    at: 9s
    workflowID: wf2
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 70s
    workflowID: wf2
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster0
      completedByWorkersInCluster: cluster1

  # Start a few more workflows on cluster0 right at/after failover time with 10s delay start.
  # They will be processed by cluster1 workers.
  - op: start_workflow
    at: 10s
    workflowID: wf3
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    delayStartSeconds: 10
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 70s
    workflowID: wf3
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1
  - op: start_workflow
    at: 11s
    workflowID: wf4
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    delayStartSeconds: 10
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 71s
    workflowID: wf4
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1
  - op: start_workflow
    at: 12s
    workflowID: wf5
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    delayStartSeconds: 10
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 72s
    workflowID: wf5
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1
  - op: start_workflow
    at: 13s
    workflowID: wf6
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    delayStartSeconds: 10
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 73s
    workflowID: wf6
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1

  # Start a workflow on cluster0 after domain cache is updated (failover time + 10s refresh interval). Request should be forwarded to cluster1.
  - op: start_workflow
    at: 25s
    workflowID: wf7
    workflowType: timer-activity-loop-workflow
    cluster: cluster0
    domain: test-domain-aa
    workflowExecutionStartToCloseTimeout: 45s
    workflowDuration: 35s
    activeClusterSelectionPolicy:
      clusterAttribute:
        scope: region
        name: region0
  - op: validate
    at: 75s
    workflowID: wf7
    cluster: cluster0
    domain: test-domain-aa
    want:
      status: completed
      startedByWorkersInCluster: cluster1
      completedByWorkersInCluster: cluster1
